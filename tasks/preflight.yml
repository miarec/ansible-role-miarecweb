---
# Include variables and define needed variables.
- name: gather os specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - "../vars/{{ ansible_facts['distribution'] }}-{{ ansible_facts['distribution_major_version'] }}.yml"
    - "../vars/{{ ansible_facts['distribution'] }}.yml"
    - "../vars/{{ ansible_facts['os_family'] }}.yml"


- name: Check for miarecweb_version variable.
  fail:
    msg: Parameter 'miarecweb_version' must be provided. Specify the version to install (e.g., '2024.1.0.0').
  when: not miarecweb_version

- name: Check for miarecweb_secret variable.
  fail:
    msg: Parameter 'miarecweb_secret' must be provided.
  when: not miarecweb_secret

- name: Check for illeagal character in secrets.
  fail:
    msg: Illeagal character, miarecweb_secret or miarecweb_db_password cannot contain '%'.
  when:
    - miarecweb_secret is search("%") or miarecweb_db_password is search("%")

# ---------------------------------------------
# Validate TLS certificate files
# ---------------------------------------------
- name: Validate PostgreSQL TLS CA file exists
  stat:
    path: "{{ miarecweb_db_tls_ca_file }}"
  register: _db_tls_ca_stat
  when:
    - miarecweb_db_tls | bool
    - miarecweb_db_tls_ca_file | length > 0

- name: Fail if PostgreSQL TLS CA file not found
  fail:
    msg: "PostgreSQL TLS CA file not found: {{ miarecweb_db_tls_ca_file }}"
  when:
    - miarecweb_db_tls | bool
    - miarecweb_db_tls_ca_file | length > 0
    - _db_tls_ca_stat.stat is defined
    - not _db_tls_ca_stat.stat.exists

- name: Validate PostgreSQL TLS client certificate file exists
  stat:
    path: "{{ miarecweb_db_tls_cert_file }}"
  register: _db_tls_cert_stat
  when:
    - miarecweb_db_tls | bool
    - miarecweb_db_tls_cert_file | length > 0

- name: Fail if PostgreSQL TLS client certificate file not found
  fail:
    msg: "PostgreSQL TLS client certificate file not found: {{ miarecweb_db_tls_cert_file }}"
  when:
    - miarecweb_db_tls | bool
    - miarecweb_db_tls_cert_file | length > 0
    - _db_tls_cert_stat.stat is defined
    - not _db_tls_cert_stat.stat.exists

- name: Validate PostgreSQL TLS client key file exists
  stat:
    path: "{{ miarecweb_db_tls_key_file }}"
  register: _db_tls_key_stat
  when:
    - miarecweb_db_tls | bool
    - miarecweb_db_tls_key_file | length > 0

- name: Fail if PostgreSQL TLS client key file not found
  fail:
    msg: "PostgreSQL TLS client key file not found: {{ miarecweb_db_tls_key_file }}"
  when:
    - miarecweb_db_tls | bool
    - miarecweb_db_tls_key_file | length > 0
    - _db_tls_key_stat.stat is defined
    - not _db_tls_key_stat.stat.exists

- name: Validate Redis TLS CA file exists
  stat:
    path: "{{ miarecweb_redis_tls_ca_file }}"
  register: _redis_tls_ca_stat
  when:
    - miarecweb_redis_tls | bool
    - miarecweb_redis_tls_ca_file | length > 0

- name: Fail if Redis TLS CA file not found
  fail:
    msg: "Redis TLS CA file not found: {{ miarecweb_redis_tls_ca_file }}"
  when:
    - miarecweb_redis_tls | bool
    - miarecweb_redis_tls_ca_file | length > 0
    - _redis_tls_ca_stat.stat is defined
    - not _redis_tls_ca_stat.stat.exists

- name: Validate Redis TLS client certificate file exists
  stat:
    path: "{{ miarecweb_redis_tls_cert_file }}"
  register: _redis_tls_cert_stat
  when:
    - miarecweb_redis_tls | bool
    - miarecweb_redis_tls_cert_file | length > 0

- name: Fail if Redis TLS client certificate file not found
  fail:
    msg: "Redis TLS client certificate file not found: {{ miarecweb_redis_tls_cert_file }}"
  when:
    - miarecweb_redis_tls | bool
    - miarecweb_redis_tls_cert_file | length > 0
    - _redis_tls_cert_stat.stat is defined
    - not _redis_tls_cert_stat.stat.exists

- name: Validate Redis TLS client key file exists
  stat:
    path: "{{ miarecweb_redis_tls_key_file }}"
  register: _redis_tls_key_stat
  when:
    - miarecweb_redis_tls | bool
    - miarecweb_redis_tls_key_file | length > 0

- name: Fail if Redis TLS client key file not found
  fail:
    msg: "Redis TLS client key file not found: {{ miarecweb_redis_tls_key_file }}"
  when:
    - miarecweb_redis_tls | bool
    - miarecweb_redis_tls_key_file | length > 0
    - _redis_tls_key_stat.stat is defined
    - not _redis_tls_key_stat.stat.exists

# ---------------------------------------------
# Validate TLS configuration requirements
# When TLS is enabled with client certificates, the celery user
# and apache need to read the private key files. Running as root
# is not supported - a dedicated user/group must be configured.
# ---------------------------------------------
- name: Check TLS configuration requires non-root celery user
  fail:
    msg: >-
      TLS with client certificates requires a non-root celery user.
      Set 'miarecweb_celery_user' to a dedicated user (e.g., 'celery')
      and 'miarec_bin_group' to a shared group that can read the certificate files.
  when:
    - (miarecweb_db_tls | bool and miarecweb_db_tls_key_file | length > 0) or
      (miarecweb_redis_tls | bool and miarecweb_redis_tls_key_file | length > 0)
    - miarecweb_celery_user == 'root'

# ---------------------------------------------
# Detect/verify python installation on this server
# Logic:
# - If python_version has major.minor (like 3.12 or 3.12.1), look for python3.12
# - If python_version is just major (like 3) or empty, use python3
# - Validate detected version is within min/max range
# ---------------------------------------------
- name: Detect Python version
  when: not (python_install_from_source | default(false) | bool)
  block:
    # Determine target Python executable based on python_version
    - name: Set target Python executable name
      set_fact:
        _python_target_exec: >-
          {%- set parts = python_version.split('.') if python_version else [] -%}
          {%- if parts | length >= 2 -%}
          python{{ parts[0] }}.{{ parts[1] }}
          {%- else -%}
          python3
          {%- endif -%}

    # Find the Python executable
    - name: Check if target Python executable exists
      command: "{{ python_install_dir }}/bin/{{ _python_target_exec }} --version"
      register: _python_version_output
      changed_when: false

    - name: Set python_version from detected version
      set_fact:
        python_version: "{{ _python_version_output.stdout | regex_replace('^Python\\s+', '') }}"

- name: Set python_version_base fact
  set_fact:
    ## Translate full python_version (3.4.5) to the MAJOR.MINOR value, like "3.4"
    python_version_base: "{{ '.'.join(python_version.split('.')[:2]) }}"

# Validate Python version is within supported range
- name: Validate Python version is within supported range
  assert:
    that:
      - python_version_base is version(python_minimum_version, '>=')
      - python_version_base is version(python_maximum_version, '<=')
    fail_msg: >-
      Detected Python version {{ python_version }} ({{ python_version_base }}) is outside
      the supported range {{ python_minimum_version }} - {{ python_maximum_version }}.
      Please install a supported Python version.
    success_msg: "Python version {{ python_version }} is within supported range"
