---
# ---------------------------------------------
# Prepare for run (includes Python version detection)
# ---------------------------------------------
- import_tasks: preflight.yml


# ---------------------------------------------
# Install dependencies
# ---------------------------------------------
- import_tasks: dependencies.yml
  become: true

# --------------------------------------------------
# Create "miarec" group if necesasry
# --------------------------------------------------
- name: "Add miarec group '{{ miarec_bin_group }}'"
  group:
    name: "{{ miarec_bin_group }}"
    state: present
  when: miarec_bin_group != 'root'

# --------------------------------------------------
# Configure TLS certificate permissions
# When TLS is enabled with client certificates, ensure the
# certificate files are readable by the miarec_bin_group
# --------------------------------------------------
- name: Set group ownership on TLS certificate files
  file:
    path: "{{ item }}"
    group: "{{ miarec_bin_group }}"
    mode: "u=rw,g=r,o="
  loop: "{{ _tls_key_files | select | list }}"
  vars:
    _tls_key_files:
      - "{{ miarecweb_db_tls_key_file if (miarecweb_db_tls | bool and miarecweb_db_tls_key_file | length > 0) else '' }}"
      - "{{ miarecweb_redis_tls_key_file if (miarecweb_redis_tls | bool and miarecweb_redis_tls_key_file | length > 0) else '' }}"
  when:
    - miarec_bin_group != 'root'
    - _tls_key_files | select | list | length > 0
  become: true

- name: Set group ownership on TLS certificate directory
  file:
    path: "{{ item | dirname }}"
    group: "{{ miarec_bin_group }}"
    mode: "u=rwx,g=rx,o="
  loop: "{{ _tls_key_files | select | list }}"
  vars:
    _tls_key_files:
      - "{{ miarecweb_db_tls_key_file if (miarecweb_db_tls | bool and miarecweb_db_tls_key_file | length > 0) else '' }}"
      - "{{ miarecweb_redis_tls_key_file if (miarecweb_redis_tls | bool and miarecweb_redis_tls_key_file | length > 0) else '' }}"
  when:
    - miarec_bin_group != 'root'
    - _tls_key_files | select | list | length > 0
  become: true

# --------------------------------------------------
# Initialize the installation/upgrade process
# --------------------------------------------------
- name: Initialize the deploy root and gather facts
  deploy_helper:
    path: "{{ miarecweb_install_dir }}"
    release: "{{ miarecweb_version }}"
    mode: u=rwX,g=rX,o=rX
  become: true

# --------------------------------------------------
# Install/upgrade 'miarecweb' app files
# --------------------------------------------------
- import_tasks: miarecweb.yml
  become: true

# --------------------------------------------------
# Upgrade database layout
# --------------------------------------------------
- import_tasks: upgrade_db.yml
  when: miarecweb_upgrade_db|bool
  become: true

# --------------------------------------------------
# Configure apache web server
# --------------------------------------------------
- import_tasks: apache.yml
  when: miarecweb_install_apache|bool
  become: true

# --------------------------------------------------
# Configure celery + celerybeat
# --------------------------------------------------
- import_tasks: celeryd.yml
  when: miarecweb_install_celeryd|bool
  become: true

- import_tasks: celerybeat.yml
  when: miarecweb_install_celerybeat|bool
  become: true


# --------------------------------------------------
# Cleanup old and unfinished releases
# --------------------------------------------------
- name: Cleanup old releases
  deploy_helper:
    path: "{{ miarecweb_install_dir }}"
    release: "{{ ansible_facts['deploy_helper']['new_release'] }}"
    state: finalize
    keep_releases: 10
  notify:
    - reload apache
    - reload celeryd
    - reload celerybeat
    - start apache
    - start celeryd
    - start celerybeat
  become: true
