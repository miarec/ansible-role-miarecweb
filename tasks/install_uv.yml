---
- name: uv | Gather facts if not already gathered
  ansible.builtin.setup:
    gather_subset: hardware
  when: "'architecture' not in ansible_facts"
  tags: uv

- name: uv | Validate uv_version format
  ansible.builtin.assert:
    that:
      - uv_version is string
      - uv_version | length > 0
      - not (uv_version is match('^v'))
      - uv_version is match('^\\d+\\.\\d+\\.\\d+$')
    fail_msg: "uv_version must be set and match X.Y.Z (example: '0.12.3') without a leading 'v'."
  tags: uv

- name: uv | Determine architecture
  ansible.builtin.set_fact:
    _uv_architecture: >-
      {%- set arch = ansible_facts['architecture'] | default('') -%}
      {%- if arch in ['x86_64', 'amd64'] -%}
      x86_64-unknown-linux-gnu
      {%- elif arch in ['aarch64', 'arm64'] -%}
      aarch64-unknown-linux-gnu
      {%- else -%}
      unsupported
      {%- endif -%}
  tags: uv

- name: uv | Fail on unsupported architecture
  ansible.builtin.fail:
    msg: "Unsupported architecture for uv installation: {{ ansible_facts['architecture'] }}"
  when: _uv_architecture == 'unsupported'
  tags: uv

- name: uv | Ensure uv install directory exists
  ansible.builtin.file:
    path: "{{ uv_install_dir }}"
    state: directory
    mode: "0755"
  tags: uv

- name: uv | Check installed uv binary
  ansible.builtin.stat:
    path: "{{ uv_install_dir }}/uv"
  register: _uv_binaries_stat
  tags: uv

- name: uv | Initialize installed uv version
  ansible.builtin.set_fact:
    _uv_installed_version: ""
  tags: uv

- name: uv | Read installed uv version
  ansible.builtin.command: "{{ uv_install_dir }}/uv --version"
  register: _uv_version_cmd
  changed_when: false
  when: _uv_binaries_stat.stat.exists
  tags: uv

- name: uv | Extract installed uv version
  ansible.builtin.set_fact:
    _uv_installed_version: "{{ _uv_version_cmd.stdout | ansible.builtin.regex_search('(\\d+\\.\\d+\\.\\d+)', output_format='\\1') | default('') }}"
  when: _uv_binaries_stat.stat.exists
  tags: uv

- name: uv | Fail if version could not be extracted
  ansible.builtin.fail:
    msg: "uv binary exists but version could not be parsed from output: {{ _uv_version_cmd.stdout | default('') }}"
  when:
    - _uv_binaries_stat.stat.exists
    - _uv_installed_version == ''
  tags: uv

- name: uv | Determine whether installation is needed
  ansible.builtin.set_fact:
    _uv_install_needed: "{{ (not _uv_binaries_stat.stat.exists) or (_uv_installed_version != uv_version) }}"
  tags: uv

- name: uv | Install or upgrade uv
  when: _uv_install_needed | bool
  tags: uv
  block:
    - name: uv | Create temporary directory
      ansible.builtin.tempfile:
        state: directory
        prefix: uv-
      register: _uv_tmp_dir

    - name: uv | Set download URLs
      ansible.builtin.set_fact:
        _uv_archive_name: "uv-{{ _uv_architecture }}.tar.gz"
        _uv_archive_url: "{{ uv_download_base_url }}/{{ uv_version }}/uv-{{ _uv_architecture }}.tar.gz"
        _uv_checksum_url: "{{ uv_download_base_url }}/{{ uv_version }}/uv-{{ _uv_architecture }}.tar.gz.sha256"
        _uv_archive_path: "{{ _uv_tmp_dir.path }}/uv.tar.gz"
        _uv_checksum_path: "{{ _uv_tmp_dir.path }}/uv.tar.gz.sha256"

    - name: uv | Download uv archive
      ansible.builtin.get_url:
        url: "{{ _uv_archive_url }}"
        dest: "{{ _uv_archive_path }}"
        mode: "0644"

    - name: uv | Download uv checksum
      ansible.builtin.get_url:
        url: "{{ _uv_checksum_url }}"
        dest: "{{ _uv_checksum_path }}"
        mode: "0644"
      when: uv_verify_checksum | bool

    - name: uv | Read expected checksum
      ansible.builtin.slurp:
        src: "{{ _uv_checksum_path }}"
      register: _uv_checksum_slurp
      when: uv_verify_checksum | bool

    # GitHub .sha256 file format: "<hash>  <filename>" - we extract only the 64-char hex hash
    - name: uv | Parse expected checksum
      ansible.builtin.set_fact:
        _uv_expected_sha256: "{{ ((_uv_checksum_slurp.content | b64decode) | ansible.builtin.regex_search('(?i)([0-9a-f]{64})', output_format='\\1') | default('')) | lower }}"
      when: uv_verify_checksum | bool

    - name: uv | Fail if checksum could not be parsed
      ansible.builtin.fail:
        msg: "Unable to parse SHA256 checksum from {{ _uv_checksum_url }}"
      when:
        - uv_verify_checksum | bool
        - _uv_expected_sha256 | length != 64

    - name: uv | Calculate archive checksum
      ansible.builtin.stat:
        path: "{{ _uv_archive_path }}"
        checksum_algorithm: sha256
      register: _uv_archive_stat
      when: uv_verify_checksum | bool

    - name: uv | Fail if checksum does not match
      ansible.builtin.fail:
        msg: "Checksum mismatch for {{ _uv_archive_url }} (expected {{ _uv_expected_sha256 }}, got {{ _uv_archive_stat.stat.checksum }})"
      when:
        - uv_verify_checksum | bool
        - _uv_archive_stat.stat.checksum | lower != _uv_expected_sha256

    - name: uv | Extract archive
      ansible.builtin.unarchive:
        src: "{{ _uv_archive_path }}"
        dest: "{{ _uv_tmp_dir.path }}"
        remote_src: true

    - name: uv | Install uv
      ansible.builtin.copy:
        src: "{{ _uv_tmp_dir.path }}/uv-{{ _uv_architecture }}/uv"
        dest: "{{ uv_install_dir }}/uv"
        owner: root
        group: root
        mode: "0755"
        remote_src: true

    - name: uv | Install uvx
      ansible.builtin.copy:
        src: "{{ _uv_tmp_dir.path }}/uv-{{ _uv_architecture }}/uvx"
        dest: "{{ uv_install_dir }}/uvx"
        owner: root
        group: root
        mode: "0755"
        remote_src: true

  always:
    - name: uv | Clean up temporary directory
      ansible.builtin.file:
        path: "{{ _uv_tmp_dir.path | default('') }}"
        state: absent
      when: _uv_tmp_dir is defined and (_uv_tmp_dir.path | default('') | length > 0)
