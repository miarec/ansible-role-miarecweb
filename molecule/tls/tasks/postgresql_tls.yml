---
# Install and Configure PostgreSQL with TLS from system packages
# Server certificates are generated here after postgres user exists

# ============ Debian ============
- name: PostgreSQL | Update apt cache | Debian
  apt:
    update_cache: true
    cache_valid_time: 600
  changed_when: false
  when: ansible_facts['os_family'] == "Debian"

- name: PostgreSQL | Install PostgreSQL packages | Debian
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - postgresql
    - postgresql-contrib
  when: ansible_facts['os_family'] == "Debian"

# Discover PostgreSQL paths using pg_lsclusters
- name: PostgreSQL | Get cluster info | Debian
  command: pg_lsclusters -h
  register: _pg_clusters
  changed_when: false
  when: ansible_facts['os_family'] == "Debian"

# pg_lsclusters output: "version cluster port status owner data_directory log_file"
# Example: "16 main 5432 online postgres /var/lib/postgresql/16/main /var/log/..."
- name: PostgreSQL | Set PostgreSQL paths | Debian
  set_fact:
    _pg_version: "{{ _pg_clusters.stdout_lines[0].split()[0] }}"
    _pg_cluster: "{{ _pg_clusters.stdout_lines[0].split()[1] }}"
    _pg_data_dir: "{{ _pg_clusters.stdout_lines[0].split()[5] }}"
    _pg_conf_dir: "/etc/postgresql/{{ _pg_clusters.stdout_lines[0].split()[0] }}/{{ _pg_clusters.stdout_lines[0].split()[1] }}"
  when: ansible_facts['os_family'] == "Debian"

# ============ RedHat ============
- name: PostgreSQL | Install PostgreSQL packages | RedHat
  package:
    name: "{{ item }}"
    state: present
  with_items:
    - postgresql-server
    - postgresql-contrib
  register: _postgresql_install
  when: ansible_facts['os_family'] == "RedHat"

- name: PostgreSQL | Initialize the database | RedHat
  command: postgresql-setup --initdb
  when:
    - ansible_facts['os_family'] == "RedHat"
    - _postgresql_install.changed
  changed_when: true

# System PostgreSQL packages always use /var/lib/pgsql/data/
- name: PostgreSQL | Set PostgreSQL paths | RedHat
  set_fact:
    _pg_data_dir: "/var/lib/pgsql/data"
    _pg_conf_dir: "/var/lib/pgsql/data"
  when: ansible_facts['os_family'] == "RedHat"

# ============ Generate Server Certificates ============
# Now that postgres user exists, generate server certificates
- name: PostgreSQL | Create TLS directory
  file:
    path: /etc/postgresql/tls
    state: directory
    owner: postgres
    group: postgres
    mode: "0750"

- name: PostgreSQL | Generate server private key
  command: openssl genrsa -out /etc/postgresql/tls/server.key 2048
  args:
    creates: /etc/postgresql/tls/server.key

- name: PostgreSQL | Create server certificate config
  copy:
    content: |
      [req]
      distinguished_name = req_distinguished_name
      req_extensions = v3_req
      prompt = no

      [req_distinguished_name]
      CN = localhost

      [v3_req]
      keyUsage = keyEncipherment, dataEncipherment
      extendedKeyUsage = serverAuth
      subjectAltName = @alt_names

      [alt_names]
      DNS.1 = localhost
      IP.1 = 127.0.0.1
    dest: /etc/postgresql/tls/server.cnf
    mode: "0644"

- name: PostgreSQL | Generate server CSR
  command: >
    openssl req -new
    -key /etc/postgresql/tls/server.key
    -out /etc/postgresql/tls/server.csr
    -config /etc/postgresql/tls/server.cnf
  args:
    creates: /etc/postgresql/tls/server.csr

- name: PostgreSQL | Sign server certificate with CA
  command: >
    openssl x509 -req
    -in /etc/postgresql/tls/server.csr
    -CA /etc/miarecweb/tls/ca.crt
    -CAkey /etc/miarecweb/tls/ca.key
    -CAcreateserial
    -out /etc/postgresql/tls/server.crt
    -days 365 -sha256
    -extensions v3_req
    -extfile /etc/postgresql/tls/server.cnf
  args:
    creates: /etc/postgresql/tls/server.crt

- name: PostgreSQL | Copy CA certificate
  copy:
    src: /etc/miarecweb/tls/ca.crt
    dest: /etc/postgresql/tls/ca.crt
    mode: "0644"
    remote_src: true

- name: PostgreSQL | Set server key permissions
  file:
    path: /etc/postgresql/tls/server.key
    mode: "0600"
    owner: postgres
    group: postgres

- name: PostgreSQL | Set server certificate permissions
  file:
    path: /etc/postgresql/tls/server.crt
    mode: "0644"
    owner: postgres
    group: postgres

- name: PostgreSQL | Set CA certificate permissions
  file:
    path: /etc/postgresql/tls/ca.crt
    mode: "0644"
    owner: postgres
    group: postgres

# ============ Configure PostgreSQL for TLS ============
- name: PostgreSQL | Enable SSL in postgresql.conf
  lineinfile:
    path: "{{ _pg_conf_dir }}/postgresql.conf"
    regexp: "^#?ssl\\s*="
    line: "ssl = on"

- name: PostgreSQL | Configure SSL certificate file
  lineinfile:
    path: "{{ _pg_conf_dir }}/postgresql.conf"
    regexp: "^#?ssl_cert_file\\s*="
    line: "ssl_cert_file = '/etc/postgresql/tls/server.crt'"

- name: PostgreSQL | Configure SSL key file
  lineinfile:
    path: "{{ _pg_conf_dir }}/postgresql.conf"
    regexp: "^#?ssl_key_file\\s*="
    line: "ssl_key_file = '/etc/postgresql/tls/server.key'"

- name: PostgreSQL | Configure SSL CA file
  lineinfile:
    path: "{{ _pg_conf_dir }}/postgresql.conf"
    regexp: "^#?ssl_ca_file\\s*="
    line: "ssl_ca_file = '/etc/postgresql/tls/ca.crt'"

# ============ Configure pg_hba.conf for TLS ============
# Require TLS with client certificate verification
- name: PostgreSQL | Configure pg_hba.conf with hostssl
  copy:
    content: |
      # PostgreSQL Client Authentication Configuration File
      # TYPE  DATABASE        USER            ADDRESS                 METHOD
      local   all             all                                     peer
      # Require SSL with client certificate verification for IPv4 and IPv6
      hostssl miarecdb        miarec          127.0.0.1/32            md5 clientcert=verify-ca
      hostssl miarecdb        miarec          ::1/128                 md5 clientcert=verify-ca
      # Reject all non-SSL connections
      hostnossl all           all             0.0.0.0/0               reject
      hostnossl all           all             ::/0                    reject
    dest: "{{ _pg_conf_dir }}/pg_hba.conf"
    mode: "0640"
    owner: postgres
    group: postgres

# ============ Start PostgreSQL ============
- name: PostgreSQL | Start PostgreSQL service
  service:
    name: postgresql
    state: restarted

# ============ Create Database and User ============
- name: PostgreSQL | Configure PostgreSQL
  vars:
    ansible_shell_allow_world_readable_temp: true
  block:

    - name: PostgreSQL | Check if user exists
      command: psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='miarec'"
      become: true
      become_user: "postgres"
      register: _pg_user_exists
      changed_when: false

    - name: PostgreSQL | Create user
      command: psql -c "CREATE USER miarec WITH PASSWORD 'password';"
      become: true
      become_user: "postgres"
      when: _pg_user_exists.stdout != "1"
      changed_when: true

    - name: PostgreSQL | Check if database exists
      command: psql -tAc "SELECT 1 FROM pg_database WHERE datname='miarecdb'"
      become: true
      become_user: "postgres"
      register: _pg_db_exists
      changed_when: false

    - name: PostgreSQL | Create Database
      command: psql -c "CREATE DATABASE miarecdb OWNER miarec;"
      become: true
      become_user: "postgres"
      when: _pg_db_exists.stdout != "1"
      changed_when: true

    - name: PostgreSQL | Create Extensions
      command: "psql -d miarecdb -c 'CREATE EXTENSION IF NOT EXISTS \"{{ item }}\";'"
      become: true
      become_user: "postgres"
      register: _pg_ext_result
      changed_when: "'already exists' not in _pg_ext_result.stderr"
      with_items:
        - hstore
        - uuid-ossp
        - pg_stat_statements

# ============ Verify TLS Configuration ============
- name: PostgreSQL | Verify TLS connection with client certificate succeeds
  command: >
    psql
    "host=127.0.0.1 port=5432 dbname=miarecdb user=miarec password=password
    sslmode=verify-ca
    sslrootcert=/etc/miarecweb/tls/ca.crt
    sslcert=/etc/miarecweb/tls/client.crt
    sslkey=/etc/miarecweb/tls/client.key"
    -c "SELECT 1;"
  register: _pg_tls_test
  changed_when: false

- name: PostgreSQL | Verify TLS connection succeeded
  assert:
    that:
      - _pg_tls_test.rc == 0
    fail_msg: "PostgreSQL TLS connection with client certificate failed"
    success_msg: "PostgreSQL TLS connection with client certificate succeeded"

- name: PostgreSQL | Verify non-TLS connection is rejected
  command: >
    psql
    "host=127.0.0.1 port=5432 dbname=miarecdb user=miarec password=password
    sslmode=disable"
    -c "SELECT 1;"
  register: _pg_no_tls_test
  failed_when: false
  changed_when: false

- name: PostgreSQL | Verify non-TLS connection was rejected
  assert:
    that:
      - _pg_no_tls_test.rc != 0
    fail_msg: "PostgreSQL non-TLS connection should have been rejected but succeeded"
    success_msg: "PostgreSQL non-TLS connection was correctly rejected"
